Flow org.gluu.agama.supergluu.main
     Basepath ""
     Configs conf
Log "@debug --> Main flow started"

authService = Call io.jans.as.server.service.AuthenticationService#class
cdiUtil = Call io.jans.service.cdi.util.CdiUtil#bean authService
authResult = {}
obj = { success: true, assertion: "{}", isAssertion: false, showError: false, errorTitle: "", errorMessage: "" }

Repeat 3 times max
    mainForm = RRF "main.ftlh" obj
    Log "@debug Main form result %" mainForm

    authResult.success = Call cdiUtil authenticate mainForm.username mainForm.password
    authResult.uid = mainForm.username
    Log "@debug authenticate called: %" authResult
    When authResult.success is true
        userData = Call org.gluu.agama.supergluu.IdentityProcessor#accountFromUid authResult.uid
        Log "@debug Call accountFromUid response %" userData
        uid = userData.uid
        listFlow = Trigger org.gluu.agama.supergluu.list userData conf
        Log "@debug List flow completed: %" listFlow
        When listFlow.success is true
            Finish uid

res = { success: false, error: "Login attempt exceeded." }
Finish res
